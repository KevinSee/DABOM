<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Running DABOM • DABOM</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Running DABOM">
<meta property="og:description" content="DABOM">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">DABOM</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/DABOM.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/BiomarkABS/DABOM/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="DABOM_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Running DABOM</h1>
                        <h4 class="author">Kevin See</h4>
            
            <h4 class="date">18 May, 2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/BiomarkABS/DABOM/blob/master/vignettes/DABOM.Rmd"><code>vignettes/DABOM.Rmd</code></a></small>
      <div class="hidden name"><code>DABOM.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This manual describes how to run the <strong>D</strong>am <strong>A</strong>dult <strong>B</strong>ranch <strong>O</strong>ccupancy <strong>M</strong>odel (<a href="https://github.com/BiomarkABS/DABOM">DABOM</a>) for adult salmon returning to a watershed. The framework typically consists of PIT tagging a representative sample of the returning adults, and using the subsequent detections of those tags at various sites upstream (or possibly downstream) of the starting location to estimate escapement or abundance past each detection site. The DABOM model estimates transition (or movement) probabilities past various detection sites while accounting for imperfect detection at those sites, essentially a multi-state variation of a spatial Cormack-Jolly-Seber model. The DABOM package implements this kind of model in a Bayesian framework. Further mathematical details of the model can be found in <span class="citation">Waterhouse et al. (2020)</span> which can be found <a href="https://doi.org/10.1002/eap.2202">here</a>.</p>
<p>For this vignette, we will show a DABOM example for spring Chinook crossing over Tumwater Dam and in the upper Wenatchee River. We start by directing users how to query <a href="https://www.ptagis.org/">PTAGIS</a> to get all detections of adults at relevant observation sites (e.g., weirs, PIT tag arrays, etc.) for a particular spawning run from a list of “valid” PIT tags. Observation data are then “cleaned up” using the <code>PITcleanr</code> R package and a final destination or spawning location is determined for each individual. <code>PITcleanr</code> can also be used to prepare detection data for use in the <code>DABOM</code> R package and model. Next, we describe how to write a JAGS model for use in <code>DABOM</code>, and finally, run <code>DABOM</code> to estimate detection and movement probabilities within the stream network. Movement probabilities can then be multiplied by an estimate of adult escapement at Tumwater Dam to estimate escapement, with uncertainty, at any observation site (or tributary) within the Wenatchee River.</p>
<p>We estimate escapement (or abundance) for both hatchery and natural origin fish by using both types together to estimate detection probabilities, but allow movement probabilities to vary by origin, because hatchery fish are likely moving to different areas at different rates compared to natural origin fish.</p>
<div id="companion-r-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#companion-r-packages" class="anchor"></a>Companion R packages</h2>
<p><code>DABOM</code> has two companion R packages, <a href="https://github.com/BiomarkABS/PITcleanr">PITcleanr</a> and <a href="https://github.com/BiomarkABS/STADEM">STADEM</a>. <code>PITcleanr</code> can assist the user in “cleaning” sometimes unwieldy amounts of detection data from <a href="https://ptagis.org/">PTAGIS</a> and preparing that detection data for <code>DABOM</code>. <code>STADEM</code> can be used to estimate adult escapement at a dam that, when combined with movement probabilities from <code>DABOM</code>, provide an estimate of abundance or escapement at locations of interest.</p>
</div>
</div>
<div id="set-up" class="section level1">
<h1 class="hasAnchor">
<a href="#set-up" class="anchor"></a>Set-up</h1>
<p>The first step is to ensure that all appropriate software and R packages are installed on your computer. (<a href="https://cran.r-project.org/">R</a>) is a language and environment for statistical computing and graphics and is the workhorse for running all of the code and models described here. R packages are collections of functions and data sets developed by the R community for particular tasks. Some R packages used here are available from the general R community (<a href="https://cran.r-project.org/web/packages/available_packages_by_name.html">Available CRAN Packages</a>) whereas others (e.g., <code>PITcleanr</code>, <code>DABOM</code>, <code>STADEM</code>) have been developed by the package author and available on <a href="https://github.com/BiomarkABS">GitHub here</a>.</p>
<p>The <code>DABOM</code> compendium can be downloaded as a zip from from this URL: <a href="https://github.com/BiomarkABS/DABOM/archive/master.zip" class="uri">https://github.com/BiomarkABS/DABOM/archive/master.zip</a></p>
<p>Or the user can install the compendium as an R package from GitHub by using Hadley Wickham’s <code>devtools</code> package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install and load remotes, if necessary</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"devtools"</span><span class="op">)</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span><span class="op">(</span><span class="st">"BiomarkABS/DABOM"</span>, 
                         build_vignettes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><code>devtools</code> may require the downloading and installation of Rtools. The latest version of Rtools can be found <a href="https://cran.r-project.org/bin/windows/Rtools/">here</a>.</p>
<p>For the latest development version:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span><span class="op">(</span><span class="st">"BiomarkABS/DABOM@develop"</span><span class="op">)</span></code></pre></div>
<div id="jags-software" class="section level3">
<h3 class="hasAnchor">
<a href="#jags-software" class="anchor"></a>JAGS Software</h3>
<p>The user will also need the <a href="http://mcmc-jags.sourceforge.net/">JAGS</a> software to run DABOM. They can download that from <a href="https://sourceforge.net/projects/mcmc-jags/files/">SourceForge</a>. JAGS (<strong>J</strong>ust <strong>A</strong>nother <strong>G</strong>ibbs <strong>S</strong>ampler) software is used by <code>DABOM</code> for Bayesian inference. Please download version &gt;= 4.0.0.</p>
</div>
<div id="other-r-packages" class="section level3">
<h3 class="hasAnchor">
<a href="#other-r-packages" class="anchor"></a>Other R Packages</h3>
<p>The user will also need to install <code>tidyverse</code>, a series of R packages that work together for data science (i.e. data cleaning and manipulation), as well as the <code>rjags</code> package to interface with JAGS. The <code>tidyverse</code> and <code>rjags</code> packages are all available from the R community and can be installed by typing the following into your R console:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"tidyverse"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"rjags"</span><span class="op">)</span></code></pre></div>
<p><code>DABOM</code> relies on PIT tag data that has been prepared in a somewhat specific format. The R package <code>PITcleanr</code> can help the user move from raw PIT tag detections to the type of output that <code>DABOM</code> requires. Instructions for installing and using <code>PITcleanr</code> can be found on the <a href="https://biomarkabs.github.io/PITcleanr/">package website</a>.</p>
<p>Hint: We have experienced errors installing the <code>PITcleanr</code> and <code>DABOM</code> packages related to <em>“Error: (converted from warning) package ‘packagenamehere’ was built under R version x.x.x”</em>. Setting the following environment variable typically suppresses the error and allows you to successfully install the packages.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>R_REMOTES_NO_ERRORS_FROM_WARNINGS <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>When attempting to install <code>PITcleanr</code> or <code>DABOM</code> you may receive an error message similar to <em>“there is no package called ‘ggraph’”</em>. In that case, try to install the given package using the following and then attempt to install <code>PITclean</code> or <code>DABOM</code>, again.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"ggraph"</span><span class="op">)</span> <span class="co"># to install package from R cran</span>
<span class="co"># replace ggraph with the appropriate package name as needed</span></code></pre></div>
</div>
</div>
<div id="pitcleanr-output" class="section level1">
<h1 class="hasAnchor">
<a href="#pitcleanr-output" class="anchor"></a>PITcleanr output</h1>
<p>Briefly, the steps to process the data for a given run or spawn year, before being ready to run DABOM, include:</p>
<ol style="list-style-type: decimal">
<li>Generate valid PIT tag list</li>
<li>Query PTAGIS for detections</li>
<li>Develop the “river network” describing the relationship among detection sites</li>
<li>Use PITcleanr to “clean up” detection data</li>
<li>Review PITcleanr output to determine final capture histories</li>
</ol>
<p>Once those steps are complete, the following lead to escapement estimates:</p>
<ol style="list-style-type: decimal">
<li>Run DABOM to estimate detection and movement probabilities</li>
<li>Summarize DABOM results</li>
<li>Combine DABOM movement probabilities with an estimate of adult escapement at the starting node</li>
</ol>
<p>More details about the initial preparation steps can be found in the vignettes contained in the <code>PITcleanr</code> package. That vignette can also be accessed using:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/vignette.html">vignette</a></span><span class="op">(</span><span class="st">"DABOM_prep"</span>,
         package <span class="op">=</span> <span class="st">"PITcleanr"</span><span class="op">)</span></code></pre></div>
<p>For <code>DABOM</code>, the user will need</p>
<ul>
<li>a configuration file</li>
<li>a parent-child table</li>
<li>a filtered detection history (based on a PTAGIS query)</li>
</ul>
<p>The <code>PITcleanr</code> package provides an example dataset we can use to demonstrate these results. The example datasets (PTAGIS query, configuration file and parent-child table) are installed on your computer when you install <code>PITcleanr</code>. We can determine where they are, and read them into R using the following code:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/BiomarkABS/PITcleanr">PITcleanr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>

<span class="va">ptagis_file</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,
                          <span class="st">"TUM_Chinook_2015.csv"</span>,
                          package <span class="op">=</span> <span class="st">"PITcleanr"</span>,
                          mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">config_file</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,
                          <span class="st">"configuration_TUM.csv"</span>,
                          package <span class="op">=</span> <span class="st">"PITcleanr"</span>,
                          mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">parent_child_file</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>,
                                <span class="st">"parent_child_TUM.csv"</span>,
                                package <span class="op">=</span> <span class="st">"PITcleanr"</span>,
                                mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>


<span class="co"># read in parent-child table</span>
<span class="va">parent_child</span> <span class="op">=</span> <span class="fu">read_csv</span><span class="op">(</span><span class="va">parent_child_file</span><span class="op">)</span>

<span class="co"># read in configuration file</span>
<span class="va">configuration</span> <span class="op">=</span> <span class="fu">read_csv</span><span class="op">(</span><span class="va">config_file</span><span class="op">)</span></code></pre></div>
<p>We will now describe these components in more detail.</p>
<div id="configuration-file" class="section level2">
<h2 class="hasAnchor">
<a href="#configuration-file" class="anchor"></a>Configuration File</h2>
<p>The configuration file contains all the information from PTAGIS to map a particular detection record to a “node”. This mapping must include the site code, the antenna code and the antenna configuration, all of which appear in the PTAGIS query defined above. <code>PITcleanr</code> provides a function to query all the metadata associated with PTAGIS sites, and maps each array (i.e. row of antennas) at a site onto a node. The upstream arrays are labeled with the site code plus <code>A0</code> and the downstream arrays are assigned <code>B0</code>. For sites with three arrays, the middle array is grouped with the upstream array. For sites with four arrays, the upper two arrays are mapped to <code>A0</code> and the lower two arrays are mapped to <code>B0</code>. However, the user can start with the <code>ptagis_meta</code> file and construct this mapping any way they choose.</p>
<p>The key columns in a configuration file include the PTAGIS site code, the configuration ID (related to how the various antennas are laid out at a site), the antenna ID and the DABOM node that antenna is assigned to. The first three are included with PTAGIS queries of capture histories, and the inclusion of the node column allows <code>PITcleanr</code> to map every detection to a node.</p>
</div>
<div id="parent-child-table" class="section level2">
<h2 class="hasAnchor">
<a href="#parent-child-table" class="anchor"></a>Parent-Child Table</h2>
<p>The parent-child table describes the stream network in terms of which detection locations are connected to each other. A parent-child table defines the closest previous detection location (parent) for each detection location (child). If a tag is seen at a child location, it must have moved past the parent location. For adult salmonid movement, the parent location is downstream of the child location. Each child location may only have a single parent, but a parent location may have multiple child locations due to the branching nature of the stream network.</p>
<p>To run DABOM, a parent-child table must include the following columns:</p>
<ul>
<li>
<code>parent</code>: generally the PTAGIS site code of the parent location</li>
<li>
<code>child</code>: generally the PTAGIS site code of the child location</li>
<li>
<code>parent_hydro</code>: the hydrosequence of the NHDPlus layer where the parent location is</li>
<li>
<code>child_hydro</code>: the hydrosequence of the NHDPlus layer where the child location is</li>
<li>
<code>parent_rkm</code>: the river kilometer of the parent location (generally queried from PTAGIS)</li>
<li>
<code>child_rkm</code>: the river kilometer of the child location (generally queried from PTAGIS)</li>
</ul>
<p>Graphically, these relationships are shown in the figure below.</p>
<div class="figure" style="text-align: center">
<img src="DABOM_files/figure-html/parent-child-fig-1.png" alt="Graphical representation of the parent-child table, showing which sites are upstream of others. Tags start at TUM, and move down the figure." width="700"><p class="caption">
Graphical representation of the parent-child table, showing which sites are upstream of others. Tags start at TUM, and move down the figure.
</p>
</div>
</div>
<div id="filtered-capture-history" class="section level2">
<h2 class="hasAnchor">
<a href="#filtered-capture-history" class="anchor"></a>Filtered Capture History</h2>
<p>One of the assumptions in the DABOM model is that fish are making a one-way upstream migration, which ends in their spawning location. At every branching site (with multiple possible upstream paths), the fish can only move up one of those paths in the model. So if a fish is detected moving past one site and later seen moving past a different site that implies the fish swam back downstream then turned up a different tributary, both of those observations cannot be kept in the model. Before running DABOM, a user will need to “clean” the detection histories of the tags and decide if there are multiple detections like those described above which one to keep.</p>
<p><code>PITcleanr</code> can take the raw detections from PTAGIS, assign each to a node (based on the configuration file), compress them, add directionality (based on the parent-child table), and flag those tags with detections in multiple branches. For each detection, <code>PITcleanr</code> adds two columns to indicate whether each detection should be retained for DABOM: <code>auto_keep_obs</code> and <code>user_keep_obs</code>. For tags with straightforward detections (i.e. all detections appear to have one-way directional movement), the added columns <code>auto_keep_obs</code> and <code>user_keep_obs</code> will be marked <code>TRUE</code>. For tags with less straightforward movement patterns, <code>PITcleanr</code> assumes that the last detection with movement noted as “forward” or “unknown” (or “start”) is the spawning location, and attempts to mark the <code>auto_keep_obs</code> column as <code>TRUE</code> for the last detections along that movement path. For these tags, <code>prepWrapper</code> returns <code>NA</code>’s in the <code>user_keep_obs</code> column.</p>
<p>We’ve identified the output from PTAGIS provided by <code>PITcleanr</code> (<code>ptagis_file</code>). Now we can compress those observations and prepare them for DABOM. Note that in the <code>prepWrapper</code> function, we have added the detection nodes (not just site codes) to the parent-child table, using the <code>addParentChildNodes</code> function from <code>PITcleanr</code>. The <code>prepWrapper</code> function also includes a minimum and maximum observed date (<code>min_obs_date</code> and <code>max_obs_date</code>, in <code>YYYYMMDD</code> format) so the user can filter out observations before a certain date (e.g. detections of fish marked as juveniles, detections at mainstem dams prior to reaching the release point, etc.) and after a certain date (e.g. detections of kelts swimming downstream after spawning, carcasses drifting downstream after spawning, ghost detections in subsequent years, etc.).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prepped_ch</span> <span class="op">=</span> <span class="fu">PITcleanr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PITcleanr/man/prepWrapper.html">prepWrapper</a></span><span class="op">(</span>ptagis_file <span class="op">=</span> <span class="va">ptagis_file</span>,
                                    configuration <span class="op">=</span> <span class="va">configuration</span>,
                                    parent_child <span class="op">=</span> <span class="va">parent_child</span> <span class="op">%&gt;%</span>
                                      <span class="fu"><a href="https://rdrr.io/pkg/PITcleanr/man/addParentChildNodes.html">addParentChildNodes</a></span><span class="op">(</span>configuration <span class="op">=</span> <span class="va">configuration</span><span class="op">)</span>,
                                    min_obs_date <span class="op">=</span> <span class="st">"20150301"</span>,
                                    max_obs_date <span class="op">=</span> <span class="st">"20150930"</span><span class="op">)</span>
<span class="co">#&gt; Compressing detections</span>
<span class="co">#&gt; Determining starting node</span>
<span class="co">#&gt; Filtering observations prior to Mar 01, 2015 </span>
<span class="co">#&gt; Filtering observations prior to TUM </span>
<span class="co">#&gt; Determining which detections to retain</span></code></pre></div>
<p>The first 10 rows of the <code>prepped_ch</code> file look like:</p>
<table class="table">
<colgroup>
<col width="6%">
<col width="2%">
<col width="2%">
<col width="7%">
<col width="3%">
<col width="9%">
<col width="9%">
<col width="6%">
<col width="8%">
<col width="9%">
<col width="5%">
<col width="12%">
<col width="4%">
<col width="6%">
<col width="6%">
</colgroup>
<thead><tr class="header">
<th align="left">tag_code</th>
<th align="left">node</th>
<th align="right">slot</th>
<th align="left">event_type_name</th>
<th align="right">n_dets</th>
<th align="left">min_det</th>
<th align="left">max_det</th>
<th align="left">duration</th>
<th align="left">travel_time</th>
<th align="left">start_date</th>
<th align="right">node_order</th>
<th align="left">path</th>
<th align="left">direction</th>
<th align="left">auto_keep_obs</th>
<th align="left">user_keep_obs</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">384.3B239AD241</td>
<td align="left">TUM</td>
<td align="right">1</td>
<td align="left">Recapture</td>
<td align="right">1</td>
<td align="left">2015-06-05 23:59:00</td>
<td align="left">2015-06-05 23:59:00</td>
<td align="left">0.00 mins</td>
<td align="left">4.178667e+02 mins</td>
<td align="left">2015-06-05 23:59:00</td>
<td align="right">1</td>
<td align="left">TUM</td>
<td align="left">start</td>
<td align="left">TRUE</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">384.3B239AD241</td>
<td align="left">NALB0</td>
<td align="right">2</td>
<td align="left">Observation</td>
<td align="right">1</td>
<td align="left">2015-06-12 01:36:38</td>
<td align="left">2015-06-12 01:36:38</td>
<td align="left">0.00 mins</td>
<td align="left">8.737633e+03 mins</td>
<td align="left">2015-06-05 23:59:00</td>
<td align="right">2</td>
<td align="left">TUM NALB0</td>
<td align="left">forward</td>
<td align="left">TRUE</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">384.3B239AD241</td>
<td align="left">NALA0</td>
<td align="right">3</td>
<td align="left">Observation</td>
<td align="right">1</td>
<td align="left">2015-06-12 01:36:50</td>
<td align="left">2015-06-12 01:36:50</td>
<td align="left">0.00 mins</td>
<td align="left">2.000000e-01 mins</td>
<td align="left">2015-06-05 23:59:00</td>
<td align="right">3</td>
<td align="left">TUM NALB0 NALA0</td>
<td align="left">forward</td>
<td align="left">TRUE</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">384.3B239AD241</td>
<td align="left">NAUB0</td>
<td align="right">4</td>
<td align="left">Observation</td>
<td align="right">1</td>
<td align="left">2015-06-22 00:40:37</td>
<td align="left">2015-06-22 00:40:37</td>
<td align="left">0.00 mins</td>
<td align="left">1.434378e+04 mins</td>
<td align="left">2015-06-05 23:59:00</td>
<td align="right">4</td>
<td align="left">TUM NALB0 NALA0 NAUB0</td>
<td align="left">forward</td>
<td align="left">FALSE</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">384.3B239AD241</td>
<td align="left">NAUA0</td>
<td align="right">5</td>
<td align="left">Observation</td>
<td align="right">2</td>
<td align="left">2015-06-22 00:40:55</td>
<td align="left">2015-08-21 22:17:32</td>
<td align="left">87696.62 mins</td>
<td align="left">3.000000e-01 mins</td>
<td align="left">2015-06-05 23:59:00</td>
<td align="right">5</td>
<td align="left">TUM NALB0 NALA0 NAUB0 NAUA0</td>
<td align="left">forward</td>
<td align="left">FALSE</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">384.3B239AD241</td>
<td align="left">NAUB0</td>
<td align="right">6</td>
<td align="left">Observation</td>
<td align="right">2</td>
<td align="left">2015-08-21 22:18:13</td>
<td align="left">2015-08-22 00:51:37</td>
<td align="left">153.40 mins</td>
<td align="left">6.833333e-01 mins</td>
<td align="left">2015-06-05 23:59:00</td>
<td align="right">4</td>
<td align="left">TUM NALB0 NALA0 NAUB0</td>
<td align="left">backward</td>
<td align="left">FALSE</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">384.3B239AD241</td>
<td align="left">NAUA0</td>
<td align="right">7</td>
<td align="left">Observation</td>
<td align="right">3</td>
<td align="left">2015-08-22 00:52:00</td>
<td align="left">2015-08-23 03:30:18</td>
<td align="left">1598.30 mins</td>
<td align="left">3.833333e-01 mins</td>
<td align="left">2015-06-05 23:59:00</td>
<td align="right">5</td>
<td align="left">TUM NALB0 NALA0 NAUB0 NAUA0</td>
<td align="left">forward</td>
<td align="left">FALSE</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">384.3B239AD241</td>
<td align="left">NAUB0</td>
<td align="right">8</td>
<td align="left">Observation</td>
<td align="right">1</td>
<td align="left">2015-08-23 03:33:34</td>
<td align="left">2015-08-23 03:33:34</td>
<td align="left">0.00 mins</td>
<td align="left">3.266667e+00 mins</td>
<td align="left">2015-06-05 23:59:00</td>
<td align="right">4</td>
<td align="left">TUM NALB0 NALA0 NAUB0</td>
<td align="left">backward</td>
<td align="left">FALSE</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">384.3B239AD241</td>
<td align="left">NAUA0</td>
<td align="right">9</td>
<td align="left">Observation</td>
<td align="right">1</td>
<td align="left">2015-08-23 20:41:32</td>
<td align="left">2015-08-23 20:41:32</td>
<td align="left">0.00 mins</td>
<td align="left">1.027967e+03 mins</td>
<td align="left">2015-06-05 23:59:00</td>
<td align="right">5</td>
<td align="left">TUM NALB0 NALA0 NAUB0 NAUA0</td>
<td align="left">forward</td>
<td align="left">FALSE</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">384.3B239AD241</td>
<td align="left">NAUB0</td>
<td align="right">10</td>
<td align="left">Observation</td>
<td align="right">1</td>
<td align="left">2015-08-23 20:41:50</td>
<td align="left">2015-08-23 20:41:50</td>
<td align="left">0.00 mins</td>
<td align="left">3.000000e-01 mins</td>
<td align="left">2015-06-05 23:59:00</td>
<td align="right">4</td>
<td align="left">TUM NALB0 NALA0 NAUB0</td>
<td align="left">backward</td>
<td align="left">FALSE</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
<p>The next step would be for a user to filter the prepared data for all rows with <code>user_keep_obs == NA</code>, and then fill in the <code>user_keep_obs</code> column by hand for each detection node. These decisions could be guided by the <code>auto_keep_obs</code> column (<code>PITcleanr</code>’s best guess), but could also be informed by the date of detections and the user’s biological knowledge of the system. Before sending the data along to DABOM, all the missing <code>user_keep_obs</code> rows should be filled out as either <code>TRUE</code> or <code>FALSE</code>. The user can then remove all the rows where <code>user_keep_obs == FALSE</code>. For our example, we’ll accept all the <code>auto_keep_obs</code> recommendations.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filter_ch</span> <span class="op">=</span> <span class="va">prepped_ch</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>user_keep_obs <span class="op">=</span> <span class="va">auto_keep_obs</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">user_keep_obs</span><span class="op">)</span></code></pre></div>
<p>This step may be easier to perform outside of R. The <code>prepWrapper</code> function has the ability to save the output to a .csv or .xlsx file which the user can then open with other software, such as Excel. Once the user has replaced all the <code>NA</code>s or blanks in the <code>user_keep_obs</code> column with <code>TRUE</code> or <code>FALSE</code>, they can read that file back into R. The code to do this looks like this:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prepped_ch</span> <span class="op">=</span> <span class="fu">PITcleanr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/PITcleanr/man/prepWrapper.html">prepWrapper</a></span><span class="op">(</span>ptagis_file <span class="op">=</span> <span class="va">ptagis_file</span>,
                                    configuration <span class="op">=</span> <span class="va">configuration</span>,
                                    parent_child <span class="op">=</span> <span class="va">parent_child</span> <span class="op">%&gt;%</span>
                                      <span class="fu"><a href="https://rdrr.io/pkg/PITcleanr/man/addParentChildNodes.html">addParentChildNodes</a></span><span class="op">(</span>configuration <span class="op">=</span> <span class="va">configuration</span><span class="op">)</span>,
                                    min_obs_date <span class="op">=</span> <span class="st">"20150301"</span>,
                                    max_obs_date <span class="op">=</span> <span class="st">"20150930"</span>,
                                    save_file <span class="op">=</span> <span class="cn">T</span>,
                                    file_name <span class="op">=</span> <span class="st">"C:/Users/usernamehere/Desktop/PITcleanr_output.xlsx"</span><span class="op">)</span>

<span class="co"># after the user has ensured all the user_keep_obs rows are TRUE or FALSE</span>
<span class="va">filter_ch</span> <span class="op">=</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">(</span><span class="st">"C:/Users/usernamehere/Desktop/PITcleanr_output.xlsx"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">user_keep_obs</span><span class="op">)</span></code></pre></div>
<p>Finally, we’ll need to know the origin (hatchery or wild/naturally produced) of each tag. This involves constructing a tibble with two columns: <code>tag_code</code> and <code>origin</code>. The user might be able to do this based on data taken when tagging the fish, or it could be constructed from the PTAGIS file:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fish_origin</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="fu">read_csv</span><span class="op">(</span><span class="va">ptagis_file</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span>tag_code <span class="op">=</span> <span class="va">`Tag Code`</span>,
         origin <span class="op">=</span> <span class="va">`Mark Rear Type Name`</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">distinct</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>origin <span class="op">=</span> <span class="fu">str_sub</span><span class="op">(</span><span class="va">origin</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,
         origin <span class="op">=</span> <span class="fu">recode</span><span class="op">(</span><span class="va">origin</span>,
                         <span class="st">"U"</span> <span class="op">=</span> <span class="st">"W"</span><span class="op">)</span><span class="op">)</span>

<span class="va">fish_origin</span>
<span class="co">#&gt; # A tibble: 2,019 x 2</span>
<span class="co">#&gt;    tag_code       origin</span>
<span class="co">#&gt;    &lt;chr&gt;          &lt;chr&gt; </span>
<span class="co">#&gt;  1 384.3B239AD241 W     </span>
<span class="co">#&gt;  2 3D9.1BF24B20F5 W     </span>
<span class="co">#&gt;  3 3D9.1C2D76FB78 W     </span>
<span class="co">#&gt;  4 3D9.1C2D770193 W     </span>
<span class="co">#&gt;  5 3D9.1C2D91B3DE W     </span>
<span class="co">#&gt;  6 3D9.1C2D925C52 W     </span>
<span class="co">#&gt;  7 3D9.1C2D929849 W     </span>
<span class="co">#&gt;  8 3D9.1C2D93282A W     </span>
<span class="co">#&gt;  9 3D9.1C2DB9A65E H     </span>
<span class="co">#&gt; 10 3D9.1C2DC026E4 H     </span>
<span class="co">#&gt; # … with 2,009 more rows</span></code></pre></div>
<p><code>DABOM</code> currently has the ability to handle up to two types of fish (e.g. hatchery and wild). Therefore, the <code>origin</code> column of <code>fish_origin</code> should only contain a maximum of two distinct entries. Note that in the example above, we have marked all the fish with “Unknown” or “U” origin as wild, to conform to this. It is fine if all the fish have the same origin (e.g. all are wild).</p>
<p>Now our data is ready for DABOM.</p>
</div>
</div>
<div id="write-jags-model" class="section level1">
<h1 class="hasAnchor">
<a href="#write-jags-model" class="anchor"></a>Write JAGS Model</h1>
<p>The DABOM model is implemented in a Bayesian framework, using JAGS software. JAGS requires a model file (.txt format) with specific types of syntax. See the JAGS user manual for more detail about JAGS models. The <code>DABOM</code> package contains a function to write this model file, based on the relationships defined in the parent-child table, and how nodes are mapped to sites in the configuration file.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/BiomarkABS/DABOM">DABOM</a></span><span class="op">)</span>

<span class="co"># file path to the default and initial model</span>
<span class="va">basic_mod_file</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="st">"DABOM_init"</span>, fileext <span class="op">=</span> <span class="st">".txt"</span><span class="op">)</span>

<span class="fu"><a href="../reference/writeDABOM.html">writeDABOM</a></span><span class="op">(</span>file_name <span class="op">=</span> <span class="va">basic_mod_file</span>,
           parent_child <span class="op">=</span> <span class="va">parent_child</span>,
           configuration <span class="op">=</span> <span class="va">configuration</span><span class="op">)</span></code></pre></div>
<p>If the user would like the initial transition parameters (chances of moving along one of the initial branches from the starting point) to be time-varying, meaning they will shift as the season goes on, <code>writeDABOM</code> has an argument, <code>time_varying</code> which can be set to <code>TRUE</code>. This can be important when the group of tagged fish may not be representative of the total run, perhaps because the trap rate shifted over the course of the run and there exists differential run timing between fish going to those initial branches. For example, this situation often occurs at Lower Granite dam, so the initial movement parameters are allowed to shift on a weekly basis. This reduces the bias in the estimates, but will take longer to run, and does require estimates of total escapement for each strata (e.g. week) of the movement parameters.</p>
<div id="modify-jags-model" class="section level2">
<h2 class="hasAnchor">
<a href="#modify-jags-model" class="anchor"></a>Modify JAGS Model</h2>
<p>Often the user will have a parent-child table based on all the detection sites they are interested in using. However, there may have been no fish detected at some of those sites that year. Rather than let the model churn away on estimating parameters that have no data to inform them, we have devised a function to “turn off” some parameters. Some of these parameters are specific to the origin of the fish, such as turning off movement parameters past a particular site only for hatchery fish, if no hatchery fish were observed there, so the <code>fish_origin</code> input is required.</p>
<p>This includes setting the detection probability to 0 for nodes that had no detections (or were not in place during the fishes’ migration), setting the detection probability to 100% for nodes that function as single arrays with no upstream detection sites (because there is no way to estimate detection probability there), and fixing some movement probabilities to 0 if no tags were observed along that branch. Setting the detection probability to 100% may lead to a conservative estimate of escapement past that particular site (i.e. escapement was <em>at least</em> this much), but since many terminal sites are further upstream in the watershed, where most detection probabilities are likely close to 100% already, this may not be a bad assumption to make. The function <code>fixNoFishNodes</code> updates the initial JAGS file with these improvements, writes a new JAGS .txt file, and sends a message to the user about what it has done.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># filepath for specific JAGS model code for species and year</span>
<span class="va">final_mod_file</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="st">"DABOM_final"</span>, fileext <span class="op">=</span> <span class="st">".txt"</span><span class="op">)</span>

<span class="co"># writes species and year specific jags code</span>
<span class="fu"><a href="../reference/fixNoFishNodes.html">fixNoFishNodes</a></span><span class="op">(</span>init_file <span class="op">=</span> <span class="va">basic_mod_file</span>,
               file_name <span class="op">=</span> <span class="va">final_mod_file</span>,
               filter_ch <span class="op">=</span> <span class="va">filter_ch</span>,
               parent_child <span class="op">=</span> <span class="va">parent_child</span>,
               configuration <span class="op">=</span> <span class="va">configuration</span>,
               fish_origin <span class="op">=</span> <span class="va">fish_origin</span><span class="op">)</span>
<span class="co">#&gt; Fixed the following sites at 0% detection probability, because no tags were observed there:</span>
<span class="co">#&gt;   PEUB0, PEUA0, ICUB0, ICUA0 .</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Fixed the following nodes at 100% detection probability, because it is functioning as a single array with no upstream detections:</span>
<span class="co">#&gt;   LNF .</span></code></pre></div>
</div>
</div>
<div id="run-jags-model" class="section level1">
<h1 class="hasAnchor">
<a href="#run-jags-model" class="anchor"></a>Run JAGS Model</h1>
<p>To run the JAGS model, we need to set some initial values, create inputs in a format conducive to JAGS, and set which parameters we would like to track.</p>
<div id="set-initial-values" class="section level2">
<h2 class="hasAnchor">
<a href="#set-initial-values" class="anchor"></a>Set Initial Values</h2>
<p>The only initial values we need to set are for where tags are in the system, based on their observed detections. Otherwise, JAGS could randomly assign them an initial value of being in one tributary, when they are actually observed in another, which will cause JAGS to throw an error and crash.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Creates a function to spit out initial values for MCMC chains</span>
<span class="va">init_fnc</span> <span class="op">=</span> <span class="fu"><a href="../reference/setInitialValues.html">setInitialValues</a></span><span class="op">(</span>filter_ch <span class="op">=</span> <span class="va">filter_ch</span>,
                            parent_child <span class="op">=</span> <span class="va">parent_child</span>,
                            configuration <span class="op">=</span> <span class="va">configuration</span><span class="op">)</span></code></pre></div>
</div>
<div id="create-jags-input" class="section level2">
<h2 class="hasAnchor">
<a href="#create-jags-input" class="anchor"></a>Create JAGS Input</h2>
<p>JAGS requires the data to be input in the form of a list. The <code>writeDABOM</code> function has also assumed a particular format and names for the data inputs. So <code>DABOM</code> has a function to transform the data into the right format expected by JAGS:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create all the input data for the JAGS model</span>
<span class="va">jags_data</span> <span class="op">=</span> <span class="fu"><a href="../reference/createJAGSinputs.html">createJAGSinputs</a></span><span class="op">(</span>filter_ch <span class="op">=</span> <span class="va">filter_ch</span>,
                             parent_child <span class="op">=</span> <span class="va">parent_child</span>,
                             configuration <span class="op">=</span> <span class="va">configuration</span>,
                             fish_origin <span class="op">=</span> <span class="va">fish_origin</span><span class="op">)</span></code></pre></div>
<p>If the user is running a time-varying version of DABOM, they will need to add some additional data as input, namely the number of temporal strata (i.e. weeks) and which strata each tag falls into (i.e. which week did they cross the initial dam?). This can be done after running <code>createJAGSinputs</code>, by using the <code>addTimeVaryData</code> function:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># add data for time-varying movement </span>
<span class="va">jags_data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">jags_data</span>,
                <span class="fu"><a href="../reference/addTimeVaryData.html">addTimeVaryData</a></span><span class="op">(</span>filter_ch <span class="op">=</span> <span class="va">filter_ch</span>,
                                start_date <span class="op">=</span> <span class="st">"20150301"</span>,
                                end_date <span class="op">=</span> <span class="st">"20150630"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="set-parameters-to-save" class="section level2">
<h2 class="hasAnchor">
<a href="#set-parameters-to-save" class="anchor"></a>Set Parameters to Save</h2>
<p>The user needs to tell JAGS which parameters to track and save posterior samples for. Otherwise, the MCMC algorithms will run, but the output will be blank. Based on the model file, <code>DABOM</code> will pull out all the detection and movement parameters to track:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Tell JAGS which parameters in the model that it should save.</span>
<span class="va">jags_params</span> <span class="op">=</span> <span class="fu"><a href="../reference/setSavedParams.html">setSavedParams</a></span><span class="op">(</span>model_file <span class="op">=</span> <span class="va">final_mod_file</span><span class="op">)</span></code></pre></div>
<p>If the user is running a time-varying version of DABOM, the function <code>setSavedParams</code> does have an input, <code>time_varying</code>, which can be set to <code>TRUE</code>. This will add the variance parameter related to the random walk of those time-varying movement parameters, in case the user is interested in tracking that.</p>
</div>
<div id="run-mcmc" class="section level2">
<h2 class="hasAnchor">
<a href="#run-mcmc" class="anchor"></a>Run MCMC</h2>
<p>R users have developed several different packages that can be used to connect to the JAGS software and run the MCMC algorithm. Here, we will present example code that uses the <code>rjags</code> package, which was written by the author of the JAGS software. First, the user runs an adaptation or burn-in phase, which requires the path to the JAGS model file, the input data, any initial values function, the number of MCMC chains to run and the number of adaptation iterations to run. To test that the model is working, a user may set <code>n.chains = 1</code> and <code>n.adapt</code> to a small number like 5, but to actually run the model we recommend:</p>
<ul>
<li><code>n.chains = 4</code></li>
<li><code>n.adapt = 5000</code></li>
</ul>
<p>To make the results fully reproducible, we recommend setting the random number generator seed in R, using the <code><a href="https://rdrr.io/r/base/Random.html">set.seed()</a></code> function. This will ensure the same MCMC results on a particular computer, although the results may still differ on different machines.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://mcmc-jags.sourceforge.net">rjags</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>

<span class="va">jags</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rjags/man/jags.model.html">jags.model</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">final_mod_file</span>,
                  data <span class="op">=</span> <span class="va">jags_data</span>,
                  inits <span class="op">=</span> <span class="va">init_fnc</span>,
                  n.chains <span class="op">=</span> <span class="fl">4</span>,
                  n.adapt <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span></code></pre></div>
<p>If this code returns a message <code>Warning message: Adaptation incomplete</code>, this indicates further burn-in iterations should be run, which the user can do by “updating” the <code>jags</code> object using this code (and setting the <code>n.iter</code> parameter to something large enough):</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">jags</span>, 
       n.iter <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></code></pre></div>
<p>Finally, once the adaptation or burn-in phase is complete, the user can take MCMC samples of the posteriors by using the <code>coda.samples</code> function. This is where the user tells JAGS which parameters to track. The user can also set a thinning paramater, <code>thin</code>, which will save every nth sample, instead of all of them. This is useful to avoid autocorrelations in the MCMC output. Again, we would recommend the following settings:</p>
<ul>
<li><code>n.iter = 5000</code></li>
<li><code>thin = 10</code></li>
</ul>
<p>Across four chains, this results in (5000 samples / 10 (every 10th sample) * 4 chains) 2000 samples of the posteriors.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dabom_samp_tum</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rjags/man/coda.samples.html">coda.samples</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">jags</span>,
                              variable.names <span class="op">=</span> <span class="va">jags_params</span>,
                              n.iter <span class="op">=</span> <span class="fl">5000</span>,
                              thin <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="results" class="section level1">
<h1 class="hasAnchor">
<a href="#results" class="anchor"></a>Results</h1>
<p>We have included an example of posterior samples with the <code>DABOM</code> package, to save the user time when testing the package. It can be accessed by running:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"dabom_samp_tum"</span><span class="op">)</span></code></pre></div>
<div id="detection-probability-estimates" class="section level2">
<h2 class="hasAnchor">
<a href="#detection-probability-estimates" class="anchor"></a>Detection Probability Estimates</h2>
<p>If a user is interested in the estimates of detection probability, estimated at every node in the DABOM model, the <code>DABOM</code> package provides a simple function to extract these, <code><a href="../reference/summariseDetectProbs.html">summariseDetectProbs()</a></code>. The output includes the number of distinct tags observed at each node, as well as the mean, median, mode and standard deviation of the posterior distribution. It also includes the highest posterior density interval (HPDI) of whatever <span class="math inline">\(\alpha\)</span>-level the user desires (using the <code>cred_int_prob</code> argument), the default value of which is 95%. The HPDI is the narrowest interval of the posterior distribution that contains the <span class="math inline">\(\alpha\)</span>-level mass, and is the Bayesian equivalent of a confidence interval.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># summarize detection probability estimates</span>
<span class="va">detect_summ</span> <span class="op">=</span> <span class="fu"><a href="../reference/summariseDetectProbs.html">summariseDetectProbs</a></span><span class="op">(</span>dabom_mod <span class="op">=</span> <span class="va">dabom_samp_tum</span>,
                                   filter_ch <span class="op">=</span> <span class="va">filter_ch</span>,
                                   cred_int_prob <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">node</th>
<th align="right">n_tags</th>
<th align="right">mean</th>
<th align="right">median</th>
<th align="right">mode</th>
<th align="right">sd</th>
<th align="right">lowerCI</th>
<th align="right">upperCI</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">CHLA0</td>
<td align="right">1196</td>
<td align="right">0.867</td>
<td align="right">0.867</td>
<td align="right">0.869</td>
<td align="right">0.009</td>
<td align="right">0.848</td>
<td align="right">0.885</td>
</tr>
<tr class="even">
<td align="left">CHLB0</td>
<td align="right">1202</td>
<td align="right">0.871</td>
<td align="right">0.872</td>
<td align="right">0.872</td>
<td align="right">0.009</td>
<td align="right">0.853</td>
<td align="right">0.888</td>
</tr>
<tr class="odd">
<td align="left">CHUA0</td>
<td align="right">631</td>
<td align="right">0.651</td>
<td align="right">0.651</td>
<td align="right">0.649</td>
<td align="right">0.016</td>
<td align="right">0.618</td>
<td align="right">0.682</td>
</tr>
<tr class="even">
<td align="left">CHUB0</td>
<td align="right">868</td>
<td align="right">0.894</td>
<td align="right">0.895</td>
<td align="right">0.894</td>
<td align="right">0.012</td>
<td align="right">0.870</td>
<td align="right">0.917</td>
</tr>
<tr class="odd">
<td align="left">CHWA0</td>
<td align="right">10</td>
<td align="right">0.910</td>
<td align="right">0.933</td>
<td align="right">0.975</td>
<td align="right">0.081</td>
<td align="right">0.740</td>
<td align="right">1.000</td>
</tr>
<tr class="even">
<td align="left">CHWB0</td>
<td align="right">10</td>
<td align="right">0.907</td>
<td align="right">0.932</td>
<td align="right">0.975</td>
<td align="right">0.085</td>
<td align="right">0.735</td>
<td align="right">1.000</td>
</tr>
<tr class="odd">
<td align="left">ICLA0</td>
<td align="right">12</td>
<td align="right">0.623</td>
<td align="right">0.631</td>
<td align="right">0.656</td>
<td align="right">0.104</td>
<td align="right">0.429</td>
<td align="right">0.829</td>
</tr>
<tr class="even">
<td align="left">ICLB0</td>
<td align="right">14</td>
<td align="right">0.717</td>
<td align="right">0.727</td>
<td align="right">0.739</td>
<td align="right">0.096</td>
<td align="right">0.528</td>
<td align="right">0.892</td>
</tr>
<tr class="odd">
<td align="left">ICMA0</td>
<td align="right">2</td>
<td align="right">0.640</td>
<td align="right">0.671</td>
<td align="right">0.901</td>
<td align="right">0.243</td>
<td align="right">0.197</td>
<td align="right">0.999</td>
</tr>
<tr class="even">
<td align="left">ICMB0</td>
<td align="right">1</td>
<td align="right">0.433</td>
<td align="right">0.414</td>
<td align="right">0.319</td>
<td align="right">0.229</td>
<td align="right">0.056</td>
<td align="right">0.863</td>
</tr>
<tr class="odd">
<td align="left">LNF</td>
<td align="right">3</td>
<td align="right">1.000</td>
<td align="right">1.000</td>
<td align="right">1.000</td>
<td align="right">0.000</td>
<td align="right">1.000</td>
<td align="right">1.000</td>
</tr>
<tr class="even">
<td align="left">LWNA0</td>
<td align="right">47</td>
<td align="right">0.839</td>
<td align="right">0.875</td>
<td align="right">0.955</td>
<td align="right">0.138</td>
<td align="right">0.544</td>
<td align="right">1.000</td>
</tr>
<tr class="odd">
<td align="left">LWNB0</td>
<td align="right">5</td>
<td align="right">0.106</td>
<td align="right">0.099</td>
<td align="right">0.092</td>
<td align="right">0.043</td>
<td align="right">0.031</td>
<td align="right">0.190</td>
</tr>
<tr class="even">
<td align="left">NALA0</td>
<td align="right">199</td>
<td align="right">0.943</td>
<td align="right">0.944</td>
<td align="right">0.945</td>
<td align="right">0.017</td>
<td align="right">0.907</td>
<td align="right">0.972</td>
</tr>
<tr class="odd">
<td align="left">NALB0</td>
<td align="right">175</td>
<td align="right">0.830</td>
<td align="right">0.831</td>
<td align="right">0.835</td>
<td align="right">0.025</td>
<td align="right">0.784</td>
<td align="right">0.879</td>
</tr>
<tr class="even">
<td align="left">NAUA0</td>
<td align="right">85</td>
<td align="right">0.957</td>
<td align="right">0.961</td>
<td align="right">0.966</td>
<td align="right">0.021</td>
<td align="right">0.914</td>
<td align="right">0.990</td>
</tr>
<tr class="odd">
<td align="left">NAUB0</td>
<td align="right">90</td>
<td align="right">0.977</td>
<td align="right">0.980</td>
<td align="right">0.988</td>
<td align="right">0.016</td>
<td align="right">0.946</td>
<td align="right">1.000</td>
</tr>
<tr class="even">
<td align="left">PESA0</td>
<td align="right">1</td>
<td align="right">0.604</td>
<td align="right">0.629</td>
<td align="right">0.878</td>
<td align="right">0.256</td>
<td align="right">0.139</td>
<td align="right">1.000</td>
</tr>
<tr class="odd">
<td align="left">PESB0</td>
<td align="right">1</td>
<td align="right">0.608</td>
<td align="right">0.635</td>
<td align="right">0.864</td>
<td align="right">0.258</td>
<td align="right">0.148</td>
<td align="right">1.000</td>
</tr>
<tr class="even">
<td align="left">TUM</td>
<td align="right">2018</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">WTLA0</td>
<td align="right">121</td>
<td align="right">0.956</td>
<td align="right">0.958</td>
<td align="right">0.966</td>
<td align="right">0.019</td>
<td align="right">0.920</td>
<td align="right">0.988</td>
</tr>
<tr class="even">
<td align="left">WTLB0</td>
<td align="right">109</td>
<td align="right">0.861</td>
<td align="right">0.863</td>
<td align="right">0.865</td>
<td align="right">0.032</td>
<td align="right">0.801</td>
<td align="right">0.920</td>
</tr>
<tr class="odd">
<td align="left">ICUA0</td>
<td align="right">0</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
</tr>
<tr class="even">
<td align="left">ICUB0</td>
<td align="right">0</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
</tr>
<tr class="odd">
<td align="left">PEUA0</td>
<td align="right">0</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
</tr>
<tr class="even">
<td align="left">PEUB0</td>
<td align="right">0</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
<td align="right">0.000</td>
</tr>
</tbody>
</table>
</div>
<div id="estimate-escapement" class="section level2">
<h2 class="hasAnchor">
<a href="#estimate-escapement" class="anchor"></a>Estimate Escapement</h2>
<p>To estimate escapement past each detection point, DABOM requires two things: an estimate of the movement or transition probability past that point, and an estimate of the total escapement somewhere in the stream network. Most of the time, that estimate of total escapement is provided at the tagging or release site (e.g. Tumwater Dam), and we’ll assume that’s what is available for this example.</p>
<div id="compile-transition-probabilities" class="section level3">
<h3 class="hasAnchor">
<a href="#compile-transition-probabilities" class="anchor"></a>Compile Transition Probabilities</h3>
<p>Compiling the transition probabilities is both a matter of ensuring that the parameters from JAGS match the site codes of each detection point (so that movement past CHL is named as such), but also multiplying some transition probabilities together when appropriate. For instance, the ultimate probability that a tag moves past CHU is the probability of moving from TUM past CHL, and then from CHL past CHU. At this time, these multiplication steps are hard-coded into a few functions, one for each version of DABOM that currently exists:</p>
<ul>
<li>Lower Granite Dam: <code><a href="../reference/compileTransProbs_GRA.html">compileTransProbs_GRA()</a></code>
</li>
<li>Priest Rapids Dam: <code><a href="../reference/compileTransProbs_PRA.html">compileTransProbs_PRA()</a></code>
</li>
<li>Tumwater Dam: <code><a href="../reference/compileTransProbs_TUM.html">compileTransProbs_TUM()</a></code>
</li>
<li>Prosser Dam: <code><a href="../reference/compileTransProbs_PRO.html">compileTransProbs_PRO()</a></code>
</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">trans_df</span> <span class="op">=</span> <span class="fu"><a href="../reference/compileTransProbs_TUM.html">compileTransProbs_TUM</a></span><span class="op">(</span>dabom_mod <span class="op">=</span> <span class="va">dabom_samp_tum</span>,
                                 parent_child <span class="op">=</span> <span class="va">parent_child</span><span class="op">)</span></code></pre></div>
<p>The resulting tibble contains a column describing the MCMC chain that sample is from (<code>chain</code>) the overall iteration of that sample (<code>iter</code>), the origin, either one or two (<code>origin</code>), the parameter (<code>param</code>) which is coded such that the site code refers to the probability of moving past that site, and the value of the posterior sample (<code>value</code>). Some parameters end in <code>_bb</code>, which refers to the tags that moved past a particular branching node, but did not move into one of the subsequent branches. The “bb” stands for “black box”, meaning we’re not sure exactly what happened to those fish. They have spawned in an area above that branching node, but below upstream detection points, they may have died in that area (due to natural causes or fishing) or they may have moved downstream undetected and were not seen at any other detection sites.</p>
</div>
<div id="total-escapement" class="section level3">
<h3 class="hasAnchor">
<a href="#total-escapement" class="anchor"></a>Total Escapement</h3>
<p>In our example, at Tumwater Dam, every fish that moves upstream of the dam is physically moved upstream, after being identified as hatchery or wild. Therefore, the total escapement, by origin, at Tumwater is known precisely, with no standard error (for 2015, there were 1,086 natural origin Chinook and 1378 hatchery Chinook). The user can input that by setting up a tibble with origin and total escapement.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tot_escp</span> <span class="op">=</span> <span class="fu">tibble</span><span class="op">(</span>origin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>,
                    tot_escp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1086</span>, <span class="fl">1378</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Each of the transition probabilities can then be multiplied by this total escapement, resulting in posterior samples of escapement or abundance past each detection site. If there is any uncertainty in the total escapement, we recommend bootstrapping samples of the total escapement with the appropriate mean and standard error (using the same number of bootstrap samples as they have posterior samples of transition probabilities), labeling those bootstraps with an iteration number <code>iter</code> and joining them to the <code>trans_df</code> tibble by <code>iter</code> and <code>origin</code>.</p>
<p>We have included some code to help summarize those posteriors below, but the user could summarize the posterior samples however they wish.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">escp_summ</span> <span class="op">=</span> <span class="va">trans_df</span> <span class="op">%&gt;%</span>
    <span class="fu">left_join</span><span class="op">(</span><span class="va">tot_escp</span>,
              by <span class="op">=</span> <span class="st">"origin"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>escp <span class="op">=</span> <span class="va">tot_escp</span> <span class="op">*</span> <span class="va">value</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_by</span><span class="op">(</span>location <span class="op">=</span> <span class="va">param</span>,
             <span class="va">origin</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">summarise</span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">escp</span><span class="op">)</span>,
              median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">escp</span><span class="op">)</span>,
              mode <span class="op">=</span> <span class="fu"><a href="../reference/estMode.html">estMode</a></span><span class="op">(</span><span class="va">escp</span><span class="op">)</span>,
              sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">escp</span><span class="op">)</span>,
              skew <span class="op">=</span> <span class="fu">moments</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/moments/man/skewness.html">skewness</a></span><span class="op">(</span><span class="va">escp</span><span class="op">)</span>,
              kurtosis <span class="op">=</span> <span class="fu">moments</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/moments/man/kurtosis.html">kurtosis</a></span><span class="op">(</span><span class="va">escp</span><span class="op">)</span>,
              lowerCI <span class="op">=</span> <span class="fu">coda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/HPDinterval.html">HPDinterval</a></span><span class="op">(</span><span class="fu">coda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html">as.mcmc</a></span><span class="op">(</span><span class="va">escp</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,
              upperCI <span class="op">=</span> <span class="fu">coda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/HPDinterval.html">HPDinterval</a></span><span class="op">(</span><span class="fu">coda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html">as.mcmc</a></span><span class="op">(</span><span class="va">escp</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,
              .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mean</span>, <span class="va">median</span>, <span class="va">mode</span>, <span class="va">sd</span>, <span class="fu">matches</span><span class="op">(</span><span class="st">'CI$'</span><span class="op">)</span><span class="op">)</span>,
                  <span class="op">~</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">.</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mean</span>, <span class="va">median</span>, <span class="va">mode</span>, <span class="va">sd</span>, <span class="va">skew</span>, <span class="va">kurtosis</span>, <span class="fu">matches</span><span class="op">(</span><span class="st">'CI$'</span><span class="op">)</span><span class="op">)</span>,
                  <span class="va">round</span>,
                  digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">origin</span><span class="op">)</span>, <span class="va">location</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">location</th>
<th align="right">origin</th>
<th align="right">mean</th>
<th align="right">median</th>
<th align="right">mode</th>
<th align="right">sd</th>
<th align="right">skew</th>
<th align="right">kurtosis</th>
<th align="right">lowerCI</th>
<th align="right">upperCI</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">CHL</td>
<td align="right">2</td>
<td align="right">1124.67</td>
<td align="right">1125.20</td>
<td align="right">1127.11</td>
<td align="right">15.87</td>
<td align="right">-0.11</td>
<td align="right">2.95</td>
<td align="right">1093.96</td>
<td align="right">1156.05</td>
</tr>
<tr class="even">
<td align="left">CHU</td>
<td align="right">2</td>
<td align="right">760.91</td>
<td align="right">761.21</td>
<td align="right">762.42</td>
<td align="right">20.71</td>
<td align="right">-0.03</td>
<td align="right">3.00</td>
<td align="right">719.97</td>
<td align="right">802.18</td>
</tr>
<tr class="odd">
<td align="left">CHW</td>
<td align="right">2</td>
<td align="right">8.43</td>
<td align="right">8.03</td>
<td align="right">7.33</td>
<td align="right">3.19</td>
<td align="right">0.69</td>
<td align="right">3.49</td>
<td align="right">2.61</td>
<td align="right">14.50</td>
</tr>
<tr class="even">
<td align="left">ICL</td>
<td align="right">2</td>
<td align="right">17.49</td>
<td align="right">17.10</td>
<td align="right">15.55</td>
<td align="right">4.54</td>
<td align="right">0.58</td>
<td align="right">3.70</td>
<td align="right">9.29</td>
<td align="right">26.31</td>
</tr>
<tr class="odd">
<td align="left">ICL_bb</td>
<td align="right">2</td>
<td align="right">10.22</td>
<td align="right">9.94</td>
<td align="right">9.06</td>
<td align="right">4.01</td>
<td align="right">0.49</td>
<td align="right">3.53</td>
<td align="right">2.76</td>
<td align="right">18.75</td>
</tr>
<tr class="even">
<td align="left">ICM</td>
<td align="right">2</td>
<td align="right">4.24</td>
<td align="right">3.49</td>
<td align="right">2.47</td>
<td align="right">2.86</td>
<td align="right">1.45</td>
<td align="right">5.80</td>
<td align="right">0.30</td>
<td align="right">9.79</td>
</tr>
<tr class="odd">
<td align="left">ICU</td>
<td align="right">2</td>
<td align="right">2.11</td>
<td align="right">1.57</td>
<td align="right">0.59</td>
<td align="right">1.99</td>
<td align="right">1.97</td>
<td align="right">9.40</td>
<td align="right">0.00</td>
<td align="right">5.96</td>
</tr>
<tr class="even">
<td align="left">LNF</td>
<td align="right">2</td>
<td align="right">3.03</td>
<td align="right">2.69</td>
<td align="right">2.13</td>
<td align="right">1.84</td>
<td align="right">1.28</td>
<td align="right">5.47</td>
<td align="right">0.32</td>
<td align="right">6.68</td>
</tr>
<tr class="odd">
<td align="left">LWN</td>
<td align="right">2</td>
<td align="right">2.92</td>
<td align="right">2.35</td>
<td align="right">1.45</td>
<td align="right">2.22</td>
<td align="right">1.79</td>
<td align="right">8.31</td>
<td align="right">0.03</td>
<td align="right">7.31</td>
</tr>
<tr class="even">
<td align="left">NAL</td>
<td align="right">2</td>
<td align="right">39.15</td>
<td align="right">38.82</td>
<td align="right">38.86</td>
<td align="right">6.76</td>
<td align="right">0.33</td>
<td align="right">3.03</td>
<td align="right">26.73</td>
<td align="right">52.78</td>
</tr>
<tr class="odd">
<td align="left">NAU</td>
<td align="right">2</td>
<td align="right">11.35</td>
<td align="right">10.98</td>
<td align="right">10.54</td>
<td align="right">3.60</td>
<td align="right">0.64</td>
<td align="right">3.45</td>
<td align="right">5.12</td>
<td align="right">18.47</td>
</tr>
<tr class="even">
<td align="left">PES</td>
<td align="right">2</td>
<td align="right">3.13</td>
<td align="right">2.42</td>
<td align="right">1.64</td>
<td align="right">3.05</td>
<td align="right">4.77</td>
<td align="right">46.50</td>
<td align="right">0.04</td>
<td align="right">7.76</td>
</tr>
<tr class="odd">
<td align="left">PEU</td>
<td align="right">2</td>
<td align="right">1.58</td>
<td align="right">1.02</td>
<td align="right">0.39</td>
<td align="right">1.94</td>
<td align="right">4.01</td>
<td align="right">30.58</td>
<td align="right">0.00</td>
<td align="right">4.68</td>
</tr>
<tr class="even">
<td align="left">TUM_bb</td>
<td align="right">2</td>
<td align="right">107.75</td>
<td align="right">107.50</td>
<td align="right">105.74</td>
<td align="right">11.50</td>
<td align="right">-0.01</td>
<td align="right">3.35</td>
<td align="right">84.74</td>
<td align="right">130.67</td>
</tr>
<tr class="odd">
<td align="left">WTL</td>
<td align="right">2</td>
<td align="right">74.47</td>
<td align="right">73.97</td>
<td align="right">73.70</td>
<td align="right">9.30</td>
<td align="right">0.30</td>
<td align="right">3.09</td>
<td align="right">55.81</td>
<td align="right">92.41</td>
</tr>
<tr class="even">
<td align="left">CHL</td>
<td align="right">1</td>
<td align="right">536.92</td>
<td align="right">537.10</td>
<td align="right">531.10</td>
<td align="right">18.41</td>
<td align="right">-0.07</td>
<td align="right">2.87</td>
<td align="right">502.51</td>
<td align="right">572.63</td>
</tr>
<tr class="odd">
<td align="left">CHU</td>
<td align="right">1</td>
<td align="right">408.94</td>
<td align="right">408.65</td>
<td align="right">406.28</td>
<td align="right">18.63</td>
<td align="right">0.02</td>
<td align="right">2.97</td>
<td align="right">373.91</td>
<td align="right">446.36</td>
</tr>
<tr class="even">
<td align="left">CHW</td>
<td align="right">1</td>
<td align="right">6.39</td>
<td align="right">5.97</td>
<td align="right">5.38</td>
<td align="right">2.87</td>
<td align="right">0.85</td>
<td align="right">3.92</td>
<td align="right">1.70</td>
<td align="right">12.36</td>
</tr>
<tr class="odd">
<td align="left">ICL</td>
<td align="right">1</td>
<td align="right">7.55</td>
<td align="right">7.18</td>
<td align="right">6.30</td>
<td align="right">3.06</td>
<td align="right">0.66</td>
<td align="right">3.39</td>
<td align="right">2.00</td>
<td align="right">13.41</td>
</tr>
<tr class="even">
<td align="left">ICL_bb</td>
<td align="right">1</td>
<td align="right">5.40</td>
<td align="right">5.00</td>
<td align="right">3.89</td>
<td align="right">2.55</td>
<td align="right">0.76</td>
<td align="right">3.36</td>
<td align="right">1.13</td>
<td align="right">10.29</td>
</tr>
<tr class="odd">
<td align="left">ICM</td>
<td align="right">1</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">NaN</td>
<td align="right">NaN</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
</tr>
<tr class="even">
<td align="left">ICU</td>
<td align="right">1</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">NaN</td>
<td align="right">NaN</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
</tr>
<tr class="odd">
<td align="left">LNF</td>
<td align="right">1</td>
<td align="right">2.16</td>
<td align="right">1.76</td>
<td align="right">1.38</td>
<td align="right">1.58</td>
<td align="right">1.49</td>
<td align="right">5.99</td>
<td align="right">0.04</td>
<td align="right">5.38</td>
</tr>
<tr class="even">
<td align="left">LWN</td>
<td align="right">1</td>
<td align="right">71.72</td>
<td align="right">68.15</td>
<td align="right">66.01</td>
<td align="right">18.80</td>
<td align="right">2.25</td>
<td align="right">12.00</td>
<td align="right">42.13</td>
<td align="right">105.85</td>
</tr>
<tr class="odd">
<td align="left">NAL</td>
<td align="right">1</td>
<td align="right">225.15</td>
<td align="right">225.03</td>
<td align="right">227.89</td>
<td align="right">15.07</td>
<td align="right">0.12</td>
<td align="right">2.83</td>
<td align="right">196.61</td>
<td align="right">254.40</td>
</tr>
<tr class="even">
<td align="left">NAU</td>
<td align="right">1</td>
<td align="right">104.06</td>
<td align="right">103.60</td>
<td align="right">103.07</td>
<td align="right">10.80</td>
<td align="right">0.20</td>
<td align="right">3.07</td>
<td align="right">84.23</td>
<td align="right">125.24</td>
</tr>
<tr class="odd">
<td align="left">PES</td>
<td align="right">1</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">NaN</td>
<td align="right">NaN</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
</tr>
<tr class="even">
<td align="left">PEU</td>
<td align="right">1</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">NaN</td>
<td align="right">NaN</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
</tr>
<tr class="odd">
<td align="left">TUM_bb</td>
<td align="right">1</td>
<td align="right">156.79</td>
<td align="right">158.66</td>
<td align="right">162.54</td>
<td align="right">20.59</td>
<td align="right">-1.26</td>
<td align="right">7.36</td>
<td align="right">118.44</td>
<td align="right">195.17</td>
</tr>
<tr class="even">
<td align="left">WTL</td>
<td align="right">1</td>
<td align="right">81.48</td>
<td align="right">80.96</td>
<td align="right">78.72</td>
<td align="right">9.68</td>
<td align="right">0.14</td>
<td align="right">2.88</td>
<td align="right">63.24</td>
<td align="right">100.40</td>
</tr>
</tbody>
</table>
</div>
<div id="time-varying-versions-gra" class="section level3">
<h3 class="hasAnchor">
<a href="#time-varying-versions-gra" class="anchor"></a>Time-Varying Versions (GRA)</h3>
<p>For DABOM models with time-varying parameters (e.g. Lower Granite Dam), calculating escapement estimates is a little more complicated. Essentially the user needs to extract the movement probabilities along each initial branch for each strata (e.g. week), and multiply those by an estimate of total escapement at the release point for that strata. Those estimates by strata can then be summed for each branch across all strata, to estimate total escapement to each initial branch across the entire run. Those branch escapement estimates are then multiplied by the subsequent movement or transition probabilities within that branch to estimate escapement past all detection points within each branch.</p>
<p>For Lower Granite, total unique wild escapement can be estimated with the <strong>ST</strong>ate-space <strong>A</strong>dult <strong>D</strong>am <strong>E</strong>escapement <strong>M</strong>odel (STADEM), which interacts well with DABOM to generate all these estimates. If the user has posterior samples from a STADEM model that was set up with the same strata as DABOM, they can generate summaries of escapement estimates using the <code><a href="../reference/calcTribEscape_GRA.html">calcTribEscape_GRA()</a></code> function. If the input <code>summ_results</code> is set to <code>FALSE</code>, the function returns a tibble with all the posterior samples that the user can then summarize as they would like.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># combine weekly escapement with other transition probabilities</span>
<span class="va">escp_summ</span> <span class="op">=</span> <span class="fu"><a href="../reference/calcTribEscape_GRA.html">calcTribEscape_GRA</a></span><span class="op">(</span>dabom_mod <span class="op">=</span> <span class="va">dabom_samp_gra</span>,
                               stadem_mod <span class="op">=</span> <span class="va">stadem_mod</span>,
                               stadem_param_nm <span class="op">=</span> <span class="st">"X.new.wild"</span>,
                               parent_child <span class="op">=</span> <span class="va">parent_child</span>,
                               summ_results <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></code></pre></div>
<p>It is important to note that the user is responsible for ensuring that the strata used in STADEM and that used in DABOM are the same. The <code><a href="../reference/addTimeVaryData.html">addTimeVaryData()</a></code> function uses a function from the <code>STADEM</code> package to generate strata on a weekly basis, so as long as the inputs are the same, the strata will be identical. However, if the user wishes to use strata from a different model (not STADEM), that are not set up to be weekly (e.g. uneven lengths, split across known changes in trap rates, etc.), it is fairly easy to generate the <code>n_strata</code> and <code>dam_strata</code> inputs to JAGS without using the <code><a href="../reference/addTimeVaryData.html">addTimeVaryData()</a></code> function, but then they must also generate estimates of escapement (by origin if necessary) for each strata. Then it is also upon the user to combine those estimates (bootstrapped if necessary due to uncertainty) with the appropriate transition probability posteriors.</p>
</div>
</div>
</div>
<div id="updating-a-dabom-model" class="section level1">
<h1 class="hasAnchor">
<a href="#updating-a-dabom-model" class="anchor"></a>Updating a DABOM Model</h1>
<p>As new detection sites are installed, the current DABOM models may need to change. The user can modify the configuration file and parent-child table through R, or manually in other software like Excel and then read those files back into R. Many of the functions in the <code>DABOM</code> package will work correctly with these updated files, including <code>writeDABOM</code>, <code>fishNoFishNodes</code>, <code>setInitialValues</code>, <code>createJAGSinputs</code> and <code>setSavedParams</code>. The user can run the JAGS model, and even pull out summaries of the detection probabilities using <code>summariseDetectProbs</code>.</p>
<p><strong><em>However</em></strong>, to generate estimates of escapement, the user will need to modify the appropriate <code>compileTransProbs_XXX</code> function to ensure that transition probabilities at the new sites are multiplied appropriately. If the Lower Granite DABOM model is modified, especially if new initial branches are added, particular care should be taken when examining the results of <code>calcTribEscape_GRA</code>, in case further adjustments are needed.</p>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-Waterhouse2020">
<p>Waterhouse, Lynn, Jody White, Kevin See, and Andrew Murdoch. 2020. “A Bayesian Nested Patch Occupancy Model to Estimate Steelhead Movement and Abundance.” <em>Ecological Applications</em> 30 (8). <a href="https://doi.org/10.1002/eap.2202">https://doi.org/10.1002/eap.2202</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Kevin See.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
